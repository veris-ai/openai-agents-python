---
search:
  exclude: true
---
# 複数エージェントのオーケストレーション

オーケストレーションとは、アプリ内でエージェントがどのように流れるかを指します。どのエージェントを、どの順番で実行し、その後の処理をどのように決定するかということです。エージェントをオーケストレーションする方法は大きく 2 つあります。

1.  LLM に意思決定させる:  LLM の知性を利用して計画・推論し、次に取るべきステップを決定します。  
2.  コードでオーケストレーションする: コード側でエージェントのフローを決定します。

これらのパターンは組み合わせて使うこともできます。それぞれにトレードオフがあり、以下で説明します。

## LLM によるオーケストレーション

エージェントとは、 instructions、tools、handoffs を備えた LLM です。つまり、オープンエンドなタスクが与えられた場合、 LLM は自律的にタスクへの取り組み方を計画し、tools を用いてアクションを実行してデータを取得し、handoffs でサブエージェントへタスクを委譲できます。例えば、リサーチ用エージェントには次のような tools を持たせられます。

-   Web 検索でオンラインの情報を取得  
-   ファイル検索および取得で専有データや接続を検索  
-   コンピュータ操作でコンピュータ上のアクションを実行  
-   コード実行でデータ分析を行う  
-   計画やレポート作成に優れた専門エージェントへの handoffs  

このパターンはタスクがオープンエンドで、 LLM の知性に頼りたい場合に最適です。ここで重要となる戦略は次のとおりです。

1. 良質なプロンプトに投資すること。利用可能な tools、その使い方、および動作すべきパラメーターの範囲を明確に示します。  
2. アプリを監視して継続的に改善すること。不具合が発生した箇所を確認し、プロンプトを繰り返し改善します。  
3. エージェントが自己分析して改善できるようにすること。たとえばループで実行して自己評価させる、あるいはエラーメッセージを提示して改善させます。  
4. 何でもこなす汎用エージェントではなく、 1 つのタスクに特化したエキスパートエージェントを用意すること。  
5. [evals](https://platform.openai.com/docs/guides/evals) に投資すること。これによりエージェントを訓練してタスク遂行能力を向上させられます。  

## コードによるオーケストレーション

 LLM によるオーケストレーションは強力ですが、コードによるオーケストレーションは速度・コスト・パフォーマンスの面でより決定論的かつ予測可能になります。代表的なパターンは次のとおりです。

-   [structured outputs](https://platform.openai.com/docs/guides/structured-outputs) を使用して、コードで検査できる適切な形式のデータを生成する。たとえばエージェントにタスクをいくつかのカテゴリーに分類させ、そのカテゴリーに基づいて次のエージェントを選択します。  
-   あるエージェントの出力を次のエージェントの入力に変換して、複数のエージェントをチェーンする。ブログ記事の執筆であれば、リサーチ → アウトライン作成 → 本文執筆 → 批評 → 改善といった一連のステップに分解できます。  
-   タスクを実行するエージェントを `while` ループで回し、評価とフィードバックを行うエージェントと組み合わせ、評価者が基準を満たしたと判断するまでループを続ける。  
-   Python の基本コンポーネントである `asyncio.gather` などを使って複数のエージェントを並列に実行する。互いに依存しない複数タスクがある場合に高速化できます。  

[`examples/agent_patterns`](https://github.com/openai/openai-agents-python/tree/main/examples/agent_patterns) には多くのコード例があります。