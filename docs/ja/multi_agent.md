---
search:
  exclude: true
---
# 複数エージェントのオーケストレーション

オーケストレーションとは、アプリ内でエージェントがどのように流れるかを指します。どのエージェントをいつ実行し、次に何をするかをどのように決定するのか、ということです。エージェントをオーケストレーションする主な方法は二つあります。

1.  LLM に意思決定させる: これは LLM の知性を利用して計画・推論を行い、それに基づいて次のステップを決定します。  
2.  コードでオーケストレーションする: コードによってエージェントの流れを決定します。

これらのパターンは組み合わせて使用できます。それぞれにトレードオフがあり、以下で説明します。

## LLM によるオーケストレーション

エージェントは、 instructions、 tools、 handoffs を備えた LLM です。これにより、オープンエンドなタスクが与えられたとき、 LLM はタスクへの取り組み方を自律的に計画し、 tools を用いてアクションやデータ取得を行い、 handoffs によってサブエージェントへタスクを委譲できます。たとえば、リサーチ用エージェントには次のような tools を持たせることができます。

-   Web 検索でオンラインの情報を取得する
-   ファイル検索と取得で自社データや接続先を調べる
-   コンピュータ操作で PC 上のアクションを実行する
-   コード実行でデータ分析を行う
-   プランニングやレポート作成などが得意な専門エージェントへの handoffs

タスクがオープンエンドで LLM の知性に頼りたい場合、このパターンは非常に有用です。ここで重要な戦術は次のとおりです。

1.  良いプロンプトに投資する。利用可能な tools、その使い方、そしてどのパラメーター内で動作すべきかを明確にします。  
2.  アプリをモニタリングし、イテレーションを重ねる。問題が発生する箇所を確認し、プロンプトを改善します。  
3.  エージェントに内省と改善を許可する。たとえば、ループで実行して自己批評させる、あるいはエラーメッセージを渡して改善させるなどです。  
4.  何でもできる汎用エージェントではなく、特定のタスクに特化して優れた専門エージェントを用意する。  
5.  [evals](https://platform.openai.com/docs/guides/evals) に投資する。これによりエージェントを学習させて、タスクへの適性を向上させられます。

## コードによるオーケストレーション

LLM によるオーケストレーションは強力ですが、コードでオーケストレーションすると、速度・コスト・パフォーマンスの面でより決定論的かつ予測可能になります。ここでよく使われるパターンは次のとおりです。

-   [structured outputs](https://platform.openai.com/docs/guides/structured-outputs) を使用して、コードで検査できる適切な形式のデータを生成します。たとえば、エージェントにタスクをいくつかのカテゴリーに分類させ、そのカテゴリーに基づいて次のエージェントを選択することができます。  
-   複数のエージェントをチェーンさせ、一方の出力を次の入力へ変換する。たとえばブログ記事の執筆というタスクを、リサーチ → アウトライン作成 → 記事執筆 → 批評 → 改善という一連のステップに分解できます。  
-   タスクを実行するエージェントと、それを評価してフィードバックを返すエージェントを `while` ループで回し、評価者が所定の基準を満たしたと判断するまで繰り返します。  
-   複数のエージェントを並列実行する。たとえば `asyncio.gather` のような Python の基本コンポーネントを使います。互いに依存しない複数タスクがある場合、速度向上に有効です。

コード例は [`examples/agent_patterns`](https://github.com/openai/openai-agents-python/tree/main/examples/agent_patterns) に多数用意しています。