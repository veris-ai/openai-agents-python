---
search:
  exclude: true
---
# 複数のエージェントのオーケストレーション

オーケストレーションとは、アプリ内でのエージェントのフローを指します。どのエージェントが実行されるのか、その順序はどうなるのか、次に何を行うかをどのように決定するのか。エージェントをオーケストレーションする方法は大きく 2 つあります。

1.  LLM に意思決定を任せる方法: LLM の知性を活用して計画・推論し、その結果に基づき次のステップを決定します。  
2.  コードでオーケストレーションする方法: コードによってエージェントのフローを決定します。

これらのパターンは組み合わせて使用できます。それぞれにトレードオフがあるため、以下で説明します。

## LLM によるオーケストレーション

エージェントとは、LLM に instructions、tools、handoffs を組み合わせたものです。オープンエンドなタスクが与えられた場合、LLM はタスクに取り組む方法を自律的に計画し、tools を使って行動やデータ取得を行い、handoffs を使ってサブエージェントにタスクを委任できます。たとえば、リサーチ用エージェントには次のようなツールを持たせることができます。

-   Web 検索でオンライン情報を取得  
-   ファイル検索とリトリーバルで独自データや接続先を検索  
-   コンピュータ操作でコンピュータ上のアクションを実行  
-   コード実行でデータ解析を実施  
-   計画立案やレポート作成などに長けた専門エージェントへの handoffs  

このパターンは、タスクがオープンエンドであり LLM の知性に頼りたい場合に最適です。主なポイントは以下のとおりです。

1.  質の高いプロンプトに投資する。利用可能なツール、その使い方、守るべきパラメーターを明確にします。  
2.  アプリを監視し、改善を重ねる。問題が発生した箇所を確認し、プロンプトを改善します。  
3.  エージェントに内省と改善を許可する。たとえばループで実行し、自己批評させる、またはエラーメッセージを提供して改善させるなどです。  
4.  何でもこなす汎用エージェントではなく、 1 つのタスクに特化したエージェントを用意します。  
5.  [evals](https://platform.openai.com/docs/guides/evals) に投資する。これによりエージェントを訓練し、タスク性能を向上できます。  

## コードによるオーケストレーション

LLM によるオーケストレーションは強力ですが、コードでオーケストレーションすると速度・コスト・性能面でより決定論的かつ予測可能になります。代表的なパターンは次のとおりです。

-   [structured outputs](https://platform.openai.com/docs/guides/structured-outputs) を用いて、コードで検査できる適切な形式のデータを生成する。たとえば、エージェントにタスクをいくつかのカテゴリーへ分類させ、そのカテゴリーに応じて次のエージェントを選択できます。  
-   複数のエージェントをチェーンし、前の出力を次の入力に変換する。ブログ記事執筆を例にすると、リサーチ → アウトライン作成 → 記事執筆 → 批評 → 改善という一連のステップに分解できます。  
-   タスクを実行するエージェントと、評価してフィードバックを返すエージェントを `while` ループで回し、評価者が基準を満たしたと判断するまで繰り返します。  
-   Python の基本コンポーネントである `asyncio.gather` などを使って複数エージェントを並列実行する。互いに依存しない複数タスクを扱う際の速度向上に有用です。  

詳細なコード例は [`examples/agent_patterns`](https://github.com/openai/openai-agents-python/tree/main/examples/agent_patterns) に用意しています。