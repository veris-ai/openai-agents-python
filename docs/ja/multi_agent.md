---
search:
  exclude: true
---
# 複数エージェントのオーケストレーション

オーケストレーションとは、アプリ内でエージェントがどのように流れるかを指します。どのエージェントを実行するか、どの順序で実行するか、次に何を行うかをどのように決定するかということです。エージェントをオーケストレーションする方法は主に 2 つあります。

1.  LLM に意思決定を任せる方法: LLM の知能を使って計画し、推論し、それに基づいて次のステップを決定します。  
2.  コードでオーケストレーションする方法: コードによってエージェントのフローを決定します。

これらのパターンを組み合わせることもできます。それぞれにトレードオフがあり、以下で説明します。

## LLM によるオーケストレーション

エージェントとは、instructions、tools、ハンドオフを備えた LLM です。つまり、オープンエンドなタスクが与えられたとき、LLM はタスクに取り組む方法を自律的に計画し、ツールを使ってアクションを実行してデータを取得し、ハンドオフを使ってサブエージェントにタスクを委任できます。たとえば、リサーチエージェントは次のようなツールを備えることができます。

-   Web 検索でオンライン情報を取得  
-   ファイル検索とリトリーバルで社内データや接続先を検索  
-   コンピュータ操作でコンピュータ上のアクションを実行  
-   コード実行でデータ分析を行う  
-   計画立案やレポート作成などが得意な専門エージェントへのハンドオフ  

このパターンはタスクがオープンエンドで、LLM の知能に依存したい場合に最適です。ここで重要なポイントは次のとおりです。

1.  良いプロンプトに投資すること。利用可能なツール、使用方法、守るべきパラメーターを明確に伝えます。  
2.  アプリをモニタリングして改善を重ねること。問題が起こる箇所を確認し、プロンプトを改善します。  
3.  エージェントに内省と改善を許可すること。たとえばループで実行し、自己批評させる、あるいはエラーメッセージを提示して改善させるなどです。  
4.  何でもこなす汎用エージェントではなく、単一タスクに長けた専門エージェントを用意すること。  
5.  [evals](https://platform.openai.com/docs/guides/evals) へ投資すること。これによりエージェントをトレーニングし、タスク性能を向上させられます。  

## コードによるオーケストレーション

LLM によるオーケストレーションは強力ですが、コードによるオーケストレーションは速度・コスト・性能の面でより決定論的かつ予測可能になります。一般的なパターンは次のとおりです。

-   [structured outputs](https://platform.openai.com/docs/guides/structured-outputs) を利用して、コードで検査可能な適切な形式のデータを生成する。たとえば、エージェントにタスクをいくつかのカテゴリーに分類させ、そのカテゴリーに基づいて次のエージェントを選ぶといった方法です。  
-   あるエージェントの出力を次のエージェントの入力に変換して複数のエージェントをチェーンする。ブログ記事作成をリサーチ → アウトライン作成 → 記事執筆 → 批評 → 改善といった一連のステップに分解できます。  
-   タスクを実行するエージェントを `while` ループで回し、別のエージェントが評価とフィードバックを行い、評価者が基準を満たしたと判定するまで繰り返す。  
-   Python の基本コンポーネントである `asyncio.gather` などを使い、複数のエージェントを並列で実行する。相互依存しない複数タスクがある場合、速度向上に有効です。  

[`examples/agent_patterns`](https://github.com/openai/openai-agents-python/tree/main/examples/agent_patterns) に多数のコード例があります。